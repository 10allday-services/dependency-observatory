# Dependency Observatory

[![CircleCI](https://circleci.com/gh/mozilla-services/dependency-observatory.svg?style=svg)](https://circleci.com/gh/mozilla-services/dependency-observatory)

### Running

See `README.md` in `kubernetes/`

### Local Development

See `README.md` in `kubernetes/`

### Database migrations

#### Changing declarative metadata

1. run `docker-compose up -d api` if the api isn't already running with `docker-compose`

1. run `./util/flask_db.sh upgrade` to ensure your local database is up to date

1. autogenerate a migration script e.g. `./util/flask_db.sh migrate -m "add foo column to bar table"`
   to create a file with that message in `/migrations/versions`

1. run `sudo chown -vR $(whoami):$(whoami) migrations/versions` so root doesn't own the script

1. review and edit the script keeping in mind the limitations of
   alembic detecting changes
   https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect

#### Adding a view

1. run `docker-compose up -d api` if the api isn't already running with `docker-compose`

1. create an empty migration file e.g. `./util/flask_db.sh revision -m "add spam_view"`

1. run `sudo chown -vR $(whoami):$(whoami) migrations/versions` so root doesn't own the script

1. add an execute operation with the raw SQL (refer to existing view
   migration scripts)
   https://alembic.sqlalchemy.org/en/latest/ops.html#alembic.operations.Operations.execute

1. For programmatic access to the view, add a table with
   `__table_args__ = {"info": {"is_view": True}}` to the declarative
   table definition in `database/models.py` (to skip it in
   autogenerated migrations)

#### Review and test the migration

1. run `docker-compose up -d api` if the api isn't already running with `docker-compose`

1. run `./util/flask_db.sh upgrade --sql` and
   `./util/flask_db.sh downgrade --sql` and review the generated SQL

1. run upgrade then downgrade without `--sql` to make sure the
   migration applies without errors

1. commit the migration script to version control

### Deployment

1. fetch the relevant images e.g.

```console
docker pull mozilla/dependency-observatory:latest mozilla/dependency-observatory:rust-1 mozilla/dependency-observatory:node-12
```

Note that you'll probably want to derive from the image to properly deamonize the worker and web server.

1. create a postgres database

1. modify `kubernetes/deployment.yaml` (e.g. remove DB point to your DB; update creds in DSN) then `kubectl create -f kubernetes/`

### Scanning, Report Building, and Scoring Process

#### score computation

Scores are very much a work in progress. They attempt to capture:

1. how much code and how many people it trusts (# unique of dependencies, # unique of maintainers)
1. library's security track record
1. code quality and activity from npms.io score

It does not try to estimate the vulnerability reporting rate.

The current scoring proposal is described in: https://docs.google.com/document/d/10kmyjHkuy3GSQc7ZEfqbbTBS_w-p6l42DV5z3fC9twc/edit#

#### scoring and report building process

Described in:

* https://docs.google.com/document/d/1JhgeL11ro2_5Cmkgti-bN_juGVbVufQ50OOo3SOtcpE/edit
* https://github.com/mozilla-services/dependency-observatory/issues/130#issuecomment-608017713
